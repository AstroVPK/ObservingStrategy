% ====================================================================
%+
% SECTION NAME:
%    wl.tex
%
% CHAPTER:
%    cosmology.tex
%
% ELEVATOR PITCH:
%-
% ====================================================================

\section{Weak Lensing}
\def\secname{wl}\label{sec:\secname}

\credit{tonytyson},
\credit{jmeyers314},
\credit{StephenRidgway}.

Much of LSST cosmology may be limited by systematic errors rather than
photon signal-to-noise. This is especially true of weak gravitational
lensing,  which relies on very accurate (\ie low bias), but very low
signal-to-noise, measurements of the shapes of galaxies, and high
signal-to-noise measurements of PSF calibration stars. As outlined in the SRD,
uniformity of seeing in the bands used for WL and special observing strategies
are required in order to reduce additive and multiplicative shear systematics.

Achieving the ultimate sensitivity of the LSST to weak lensing science places
stringent requirements on our ability to accurately measure galaxy shapes and redshifts,
which in turn demands precise and accurate knowledge of the point spread function,
astrometry, and photometry. These measurements are influenced by the interaction of
light with the Earth's atmosphere, the telescope optics, and the CCD sensors. Sysematics
in the shear are introduced in each case.   Methods have been developed for suppressing
these systematics in current lensing surveys. These and new methods will be applied to
the LSST survey.

Over the sample of 3-4 billion galaxies, the shear systematics must be below
one part in 10,000 for additive shear, and one part in 1000 for multiplicative shear.
Each visit to a sky patch encounters these systematics. Some observing strategies can
effectively randomize these over all visits to a field.  Below we discuss the observing
strategies for suppressing shear systematics and metrics for their success.

\subsection{Target Selection}

Image quality must be uniformly good in the bands used for weak lens shear.  These will be
the $r$ and $i$ bands.   Depending on the current weather and seeing, the scheduler
will have a list of priorities for next-field, based on prior history of coverage.
Nearby fields in need of coverage in these bands will be given high priority if the
seeing is better than some specified value, likely 0.7 arcsec FWHM.


\subsection{Target Measurements}

It is expected that even after maximal optimization of camera optics
and electronics, that systematic image shape errors will be associated
with the orientation of the camera focal plane.  Using data from vendor CCDs, simulations
of LSST observing have shown that a combination of x-y dithering on the sky and
pipeline processing with pixel re-map (to cancel much of the CCD frame fixed
distortions) can get well within a factor of ten of the goal for shear
systematics residuals.  Simulations which add camera angle dithering show
that the goal can be achieved in fields with relatively uniform seeing history.

Thus shear systematics will be partially reduced by randomization of the
orientation of the camera with respect to the sky.  This is
represented by the parameter RotSkyPos: we can construct diagnostic
metrics that quantify the uniformity of its distribution at each sky
position.   Given the spin 2 symmetry of shear, the optimal strategy for shear systematics
will be to aim for uniformity of RotSkyPos mod $\pi$, since angles separated by $\pi$ radians
are degenerate.

Similarly, the telescope optics may harbor systematic aberrations, and
these also could be mitigated by recording images with varying
parallactic angle.  More important is the effect of atmospheric differential chromatic
refraction: re-visits to a given field should be distributed over hour angles, consistent
with airmass and seeing limits.

Uniformity of depth is important, but less so than uniformity in camera
rotator shear suppression.  Simulations have shown that for the Gold sample of galaxies,
uniformity at the 0.2 mag level in limiting magnitude produces little shear bias. The
largest effect comes from bias in weak lens magnification tomography.


\subsection{Metrics}

For characterizing the isotropy of rotational sampling, both for rotSkyPos and the parallactic
angle, we investigate two metrics: the AngularSpreadMetric and the KuiperMetric.  The
AngularSpreadMetric characterizes the balance of a set of angular values, in the sense that opposing
angles, those separated by $\pi$ radians, have zero contribution to the AngularSpread.  The Kuiper
statistic, which is related to the well known Kolmogorov Smirnov statistic, characterizes the
departure of a distribution from uniform, but with the added quality of being invariant under cyclic
transformations of the input set of angles.

The AngularSpread metric is computed as follows:  Given a set of angles $\{\theta\}_{i=1, ..., N}$,
map these angles onto a unit circle: $(x_i, y_i) = (\cos \theta_i, \sin \theta_i)$, and find the 2D
centroid: $(\bar{x}, \bar{y}) = \frac{1}{N} (\sum_i x_i, \sum_i y_i)$.  The AngularSpread is the
distance of the 2D centroid from the unit circle:
$\mathrm{AngularSpread} = 1 - \sqrt{\bar{x}^2 + \bar{y}^2}$.  An AngularSpread of 1 therefore
corresponds to a perfectly balanced distribution, in which the averages of both $\cos \theta$ and
$\sin \theta$ are zero, while an AngularSpread of 0 indicates a maximally anisotropic distribution
in which every angle is identical: $\theta_i = \mathrm{const}$.  As mentioned above, weak lensing
shear systematics cancel to first order when those systematics are separated not by an angle of
$\pi$ radians, but by an angle of $\pi/2$ radians.  To incorporate this spin-2 nature of shear
systematics is simple, we just multiply each angle $\theta_i$ by two before applying the
AngularSpread metric, so that, for example, pairs of angles initially separated by $\pi/2$ radians
become separated by $\pi$ radians and correctly cancel.

While the AngularSpread metric does a good job at characterizing the balance of a distribution
defined on a circle, it isn't directly studying the {\emph uniformity} of said distribution.  For
instance, the AngularSpread of the angles $\{0, 0, 0, 0, \pi, \pi, \pi, \pi\}$ is zero, but the
distribution is far from uniform.  The Kolmogorov Smirnov (KS) test is well known for investigating
whether a set of data are consistent with a given distribution.  The KS statistic, off which the
test is based, is defined as the maximum absolute difference in the empirical cumulative
distribution function (CDF) of the data and the CDF of the distribution being tested.  The Kuiper
statistic is a slight modification of the KS statistic, defined as the sum of the maximum difference
and absolute minimum (maximally negative) difference between the empirical and test CDFs.  This
modification is convenient for characterizing distributions defined on a circle, since it makes the
statistic invariant under rotations of the data.  To incorporate the spin-2 nature of shear
systematics for the Kuiper statistic, we map the values $\theta_i \rightarrow \theta_i \mod \pi$ and
compare to the uniform distribution between 0 and $\pi$.

%
%
% Our figure of merit for weak lensing is $\sigma_{\rm sys}$, the
% residual shear systematic error. This is related to the uniformity of
% the sky survey in ways not yet derived, but for now we can prepare by
% calculating some low-level diagnostic metrics.
%
% A metric is available for RotSkyPos.  The metric computes, for any
% selected filter and simulation, a histogram of the distribution of rms
% values of RotSkyPos computed per field. It also computes basic
% statistics of these distributions.


\subsection{Ancilliary data}

We can use largescale patterns of distortions of the PSF over the 20,000 stars per exposure for
PSF regularization in the per-CCD PSF fitting. In the per CCD fits, there is a benefit to
setting aside some stars for validation tests of PSF extrapolation.
In addition to using all the stars in a given visit, there is useful information in the
wavefront sensors and the guide CCDs that may be used to regularize the PSF
reconstruction in a visit. We might read out guider CCDs in different ways to better
monitor the atmosphere.


\subsection{OpSim Analysis}

% \begin{figure}
% \centering\includegraphics[width=\linewidth]{figs/enigma1189RmsAnglerotSkyPosugrizybandallpropsOPSIComboHistogram.png}
% \caption{The relative angle of the detector plane with respect to the sky, RotSkyPos, as a histogram showing the number of fields vs. rms of the parameter.}
% \label{RotSkyPos}
% \end{figure}

% The distribution of rms values by filter is shown in
% \autoref{RotSkyPos} for the current candidate baseline simulation,
% enigma\_1189.  As shown, the rms values cluster around the value 1
% radian,  with typical values 1 +- 0.3 radian.  This compares to a
% completely uniform distribution over the half circle with an rms of
% 1.14.  As mentioned above, uniformity in cosine squared is the goal.
% Simulated observing of 100 visits to a field show this will produce
% a factor of 10 decrease in CCD-based shear systematics such as edge
% effects and the brighter-fatter x-y anisotropy.




\newcommand\plottwo[2]{{%
\typeout{Plottwo included the files #1 #2}
\centering
\leavevmode
\includegraphics*[width=0.45\columnwidth]{#1}%
\hfil
\includegraphics*[width=0.45\columnwidth]{#2}%
}}%


%  rotSkyPos metrics

\begin{figure}[tbh!]
\plottwo{figs/WL/minion_1016_AngularSpread_rotSkyPos_propID_54_and_i_HEAL_SkyMap.pdf}
        {figs/WL/minion_1016_AngularSpread_rotSkyPos_u_g_r_i_z_y_propID_54_HEAL_ComboHistogram.pdf}
\caption{\textbf{Left:} Sky map showing the distribution of the AngularSpread metric applied to the
    angle rotSkyPos mod $\pi$, where rotSkyPos is the angle between the $+y$ camera direction and
    North, and the modulus with period $\pi$ is taken to account for the degeneracy of angles
    separated by $\pi$ radians for spin-2 shear systematics.  An AngularSpread of 0 indicates a
    maximally anisotropic distribution (all visits have the rotSkyPos angle mod $\pi$), while an
    AngularSpread of 1 indicates that visits are maximally balanced (the fraction of angles
    rotSkyPos at $\theta$ and at $\theta + \pi/2$ are the same.)  For complete definition of the
    AngularSpread metric, please see the text.  To leading order, shear systematics permanently
    imprinted on the camera or lenses cancel when AngularSpread = 1.  \textbf{Right:} Distribution
    of the AngularSpread metric applied to (rotSkyPos mod $\pi$) for all LSST filters.}
\label{fig:WL_AngularSpread_rotSkyPos}
\end{figure}

\begin{figure}[tbh!]
\plottwo{figs/WL/minion_1016_Kuiper_rotSkyPos_propID_54_and_i_HEAL_SkyMap.pdf}
        {figs/WL/minion_1016_Kuiper_rotSkyPos_u_g_r_i_z_y_propID_54_HEAL_ComboHistogram.pdf}
\caption{\textbf{Left:} Sky map showing the distribution of the Kuiper metric (see text for
    definition) applied to the angle rotSkyPos mod $\pi$.  A Kuiper value of 0 indicates an
    isotropic distribution of angles (mod $\pi$), while a Kuiper value of 1 indicates a maximally
    anisotropic distribution. \textbf{Right:} Distribution of the Kuiper metric applied to
    (rotSkyPos mod $\pi$) for all LSST filters.}
\label{fig:WL_Kuiper_rotSkyPos}
\end{figure}

%  ParallacticAngle metrics

\begin{figure}[tbh!]
\plottwo{figs/WL/minion_1016_AngularSpread_ParallacticAngle_propID_54_and_i_HEAL_SkyMap.pdf}
        {figs/WL/minion_1016_AngularSpread_ParallacticAngle_u_g_r_i_z_y_propID_54_HEAL_ComboHistogram.pdf}
\caption{Same as Fig. \ref{fig:WL_AngularSpread_rotSkyPos}, but for the parallactic angle (the angle
    between North and zenith) instead of rotSkyPos.  The isotropy of the parallactic angle affects
    the impact of shear systematics due to differential chromatic refraction.}
\label{fig:WL_AngularSpread_ParallacticAngle}
\end{figure}

\begin{figure}[tbh!]
\plottwo{figs/WL/minion_1016_Kuiper_ParallacticAngle_propID_54_and_i_HEAL_SkyMap.pdf}
        {figs/WL/minion_1016_Kuiper_ParallacticAngle_u_g_r_i_z_y_propID_54_HEAL_ComboHistogram.pdf}
\caption{Same as Fig. \ref{fig:WL_Kuiper_rotSkyPos}, but for the parallactic angle instead of
    rotSkyPos.}
\label{fig:WL_Kuiper_ParallacticAngle}
\end{figure}


\subsection{Discussion}

The RotSkyPos metric analysis shows that the majority of fields have a
good randomization of detector angles projected on the sky.

There are some limitations to this observation.

%First, we do not have at present a quantitative requirement for
%randomization of this parameter.  In future development of weak
%lensing analysis, a criterion should be developed.

A significant fraction of fields  have median values that are
lower or higher than expected for a random distribution, with some far
from uniformly distributed.  Regardless of the $per field$ criterion,
it is desirable to avoid the incidence of individual discrepant
fields.

The recommended criterion for randomization of RotSkyPos is not the
behavior of the majority of the fields, but of the minority with the
least random behavior.  The number of non-random fields should be
minimized.  A recommended metric is the count of fields with median
RMS less then 0.8 or greater than 1.5 radians (these values to be
reviewed again as additional experience is gained with additional
OpSim schedule simulations and weak lensing analysis.)

It is certain that actively controlling the statistics of RotSkyPos
will require additional slewing of the camera rotator.  At present,
the operations plan is to only slew when necessary to prepare for a
filter change - that could be estimated at the equivalent of $\simeq
3$ complete rotations per day.  \autoref{RotSkyPos} shows that to
render the distribution completely uniform would require moving all
observing angles an average of $\simeq 30$ degrees, or 300 complete
rotations per night.  The timing of this has not been considered.
Whether or not this uniformity could be achieved with less slew time
if implemented in scheduling remains to be demonstrated.

A similar metric for RotTelPos should be developed.
